<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/html

    # Drupal specific configuration
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks +MultiViews
        AllowOverride All
        Require all granted
    </Directory>

    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"

    # Drupal files directory protection
    <Directory /var/www/html/sites/*/files>
        # Turn off all options
        Options -Indexes -ExecCGI -Includes -MultiViews
        
        # Set the catch-all handler to prevent scripts from being executed.
        SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006
        <Files *>
            # Override the handler again if we're run later in the evaluation list.
            SetHandler Drupal_Security_Do_Not_Remove_See_SA_2006_006
        </Files>
        
        # If we know how to do it safely, disable the PHP engine entirely.
        <IfModule mod_php.c>
            php_flag engine off
        </IfModule>
    </Directory>

    # Deny access to sensitive files
    <FilesMatch "\.(engine|inc|install|make|module|profile|po|sh|.*sql|theme|twig|tpl(\.php)?|xtmpl|yml|yaml)$|^(\..*|Entries.*|Repository|Root|Tag|Template|composer\.(json|lock)|web\.config)$|^#.*#$|\.php(~|\.sw[op]|\.bak|\.orig|\.save)?$">
        Require all denied
    </FilesMatch>

    # Deny access to config directories
    <DirectoryMatch "^(.*/)?\.">
        Require all denied
    </DirectoryMatch>

    # Error and access logs
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    # Health check endpoint
    Alias /health /var/www/html/health.php
</VirtualHost>
